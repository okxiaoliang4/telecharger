(function(d,u){typeof exports=="object"&&typeof module!="undefined"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(d=typeof globalThis!="undefined"?globalThis:d||self,u(d.telecharger={}))})(this,function(d){"use strict";function u(t){return fetch(t,{method:"HEAD"}).then(e=>Number(e.headers.get("Content-Length")))}async function*x(t,e,s){const n=new Set;async function i(){const[c,o]=await Promise.race(n);return n.delete(c),o}for(const c of e){const o=(async()=>await s(c,e))().then(a=>[o,a]);n.add(o),n.size>=t&&(yield await i())}for(;n.size;)yield await i()}async function v(t,e){const s=await fetch(t.url,{signal:e.signal,headers:{Range:`bytes=${t.head}-${t.end}`}}),n=s.body.getReader(),i=s.headers.get("content-type")||"application/octet-stream";for(;;){const{done:c,value:o}=await n.read();if(c){const a=new Blob([t.buffer],{type:i});return t.done(a),t}t.append(o)}}function b(t){return{all:t=t||new Map,on:function(e,s){var n=t.get(e);n?n.push(s):t.set(e,[s])},off:function(e,s){var n=t.get(e);n&&(s?n.splice(n.indexOf(s)>>>0,1):t.set(e,[]))},emit:function(e,s){var n=t.get(e);n&&n.slice().map(function(i){i(s)}),(n=t.get("*"))&&n.slice().map(function(i){i(e,s)})}}}class z{constructor(e){this.blob=null,this.url=e.url,this.index=e.index,this.start=e.start,this.head=e.start,this.end=e.end,this.buffer=new Uint8Array(this.size),this.emitter=b()}get progress(){return(this.head-this.start)/this.size}get size(){return this.end-this.start+1}append(e){this.buffer.set(e,this.head-this.start),this.head+=e.length,this.emitter.emit("progress",this.progress)}done(e){this.blob=e}}async function A(t,e={}){const s=b(),{threads:n=8,chunkSize:i=1024e4,immediate:c=!0}=e,o=await u(t),a=Math.ceil(o/i),f=new Array(a),y=new Set;for(let r=0;r<a;r++){let m=r*i,T=r+1==a?o-1:(r+1)*i-1;const h=new z({url:t,index:r,start:m,end:T});h.emitter.on("progress",M=>{const w=f.reduce((P,L)=>P+L.progress,0)/a;s.emit("progress",w),w>=1&&s.all.delete("progress"),M>=1&&h.emitter.all.delete("progress")}),f[r]=h,y.add(h)}let l="init",g;async function p(){if(!(l==="pending"||l==="done")){g=new AbortController,l="pending";try{for await(const r of x(n,Array.from(y),m=>v(m,g)))r.emitter.emit("done",r),r.emitter.all.delete("done");l="done",s.emit("done",new Blob(f.map(r=>r.blob),{type:f[0].blob.type})),s.all.delete("done")}catch(r){r.name==="AbortError"&&(l="pausing")}}}c&&p();function C(){l="pausing",g.abort()}function S(){p()}return{chunks:f,emitter:s,start:p,pause:C,resume:S}}d.telecharger=A,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
