(function(a,l){typeof exports=="object"&&typeof module!="undefined"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(a=typeof globalThis!="undefined"?globalThis:a||self,l(a.telecharger={}))})(this,function(a){"use strict";function l(t){return fetch(t,{method:"HEAD",headers:{Range:"bytes=0"}}).then(e=>e.headers)}async function*v(t,e,s){const n=new Set;async function o(){const[c,i]=await Promise.race(n);return n.delete(c),i}for(const c of e){const i=(async()=>await s(c,e))().then(u=>[i,u]);n.add(i),n.size>=t&&(yield await o())}for(;n.size;)yield await o()}async function z(t,e){const s=await fetch(t.url,{signal:e.signal,headers:{Range:`bytes=${t.head}-${t.end}`}}),n=s.body.getReader(),o=s.headers.get("content-type")||"application/octet-stream";for(;;){const{done:c,value:i}=await n.read();if(c){const u=new Blob([t.buffer],{type:o});return t.done(u),t}t.append(i)}}function b(t){return{all:t=t||new Map,on:function(e,s){var n=t.get(e);n?n.push(s):t.set(e,[s])},off:function(e,s){var n=t.get(e);n&&(s?n.splice(n.indexOf(s)>>>0,1):t.set(e,[]))},emit:function(e,s){var n=t.get(e);n&&n.slice().map(function(o){o(s)}),(n=t.get("*"))&&n.slice().map(function(o){o(e,s)})}}}class C{constructor(e){this.blob=null,this.url=e.url,this.index=e.index,this.start=e.start,this.head=e.start,this.end=e.end,this.buffer=new Uint8Array(this.size),this.emitter=b()}get progress(){return(this.head-this.start)/this.size}get size(){return this.end-this.start+1}append(e){this.buffer.set(e,this.head-this.start),this.head+=e.length,this.emitter.emit("progress",this.progress)}done(e){this.blob=e}}class g extends Error{constructor(e){super(e)}}async function E(t,e={}){var S;const s=b(),{threads:n=8,chunkSize:o=1024e4,immediate:c=!0}=e,i=await l(t),u=i.get("Content-Type");if(!((S=i.get("Accept-Ranges"))==null?void 0:S.includes("bytes")))throw new g("unsupported http range");const R=i.get("Content-Range");if(!R)throw new g("no Content-Range");const x=Number(R.split("/")[1]),h=Math.ceil(x/o),f=new Array(h),A=new Set;for(let r=0;r<h;r++){let w=r*o,U=r+1==h?x-1:(r+1)*o-1;const p=new C({url:t,index:r,start:w,end:U});p.emitter.on("progress",j=>{const T=f.reduce((B,H)=>B+H.progress,0)/h;s.emit("progress",T),T>=1&&s.all.delete("progress"),j>=1&&p.emitter.all.delete("progress")}),f[r]=p,A.add(p)}let d=0,m;async function y(){if(!(d===1||d===4)){m=new AbortController,d=1;try{for await(const r of v(n,Array.from(A),w=>z(w,m)))r.emitter.emit("done",r),r.emitter.all.delete("done");d=4,s.emit("done",new Blob(f.map(r=>r.blob),{type:u})),s.all.delete("done")}catch(r){(r==null?void 0:r.name)==="AbortError"?d=2:(d=3,s.emit("error",r))}}}c&&y();function M(){d=2,m.abort()}function P(){y()}return{chunks:f,emitter:s,start:y,pause:M,resume:P}}a.UnsupportedRangeError=g,a.telecharger=E,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
