(function(a,u){typeof exports=="object"&&typeof module!="undefined"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(a=typeof globalThis!="undefined"?globalThis:a||self,u(a.telecharger={}))})(this,function(a){"use strict";function u(t){return fetch(t,{method:"HEAD",headers:{Range:"bytes=0-1"}}).then(e=>e.headers)}async function*T(t,e,s){const n=new Set;async function o(){const[c,i]=await Promise.race(n);return n.delete(c),i}for(const c of e){const i=(async()=>await s(c,e))().then(l=>[i,l]);n.add(i),n.size>=t&&(yield await o())}for(;n.size;)yield await o()}async function v(t,e){const s=await fetch(t.url,{signal:e.signal,headers:{Range:`bytes=${t.head}-${t.end}`}}),n=s.body.getReader(),o=s.headers.get("content-type")||"application/octet-stream";for(;;){const{done:c,value:i}=await n.read();if(c){const l=new Blob([t.buffer],{type:o});return t.done(l),t}t.append(i)}}function b(t){return{all:t=t||new Map,on:function(e,s){var n=t.get(e);n?n.push(s):t.set(e,[s])},off:function(e,s){var n=t.get(e);n&&(s?n.splice(n.indexOf(s)>>>0,1):t.set(e,[]))},emit:function(e,s){var n=t.get(e);n&&n.slice().map(function(o){o(s)}),(n=t.get("*"))&&n.slice().map(function(o){o(e,s)})}}}class z{constructor(e){this.blob=null,this.url=e.url,this.index=e.index,this.start=e.start,this.head=e.start,this.end=e.end,this.buffer=new Uint8Array(this.size),this.emitter=b()}get progress(){return(this.head-this.start)/this.size}get size(){return this.end-this.start+1}append(e){this.buffer.set(e,this.head-this.start),this.head+=e.length,this.emitter.emit("progress",this.progress)}done(e){this.blob=e}}class w extends Error{constructor(e){super(e)}}async function C(t,e={}){var A;const s=b(),{threads:n=8,chunkSize:o=1024e4,immediate:c=!0}=e,i=await u(t),l=i.get("Content-Type");if(!((A=i.get("Accept-Ranges"))==null?void 0:A.includes("bytes")))throw new w("unsupported http range");const R=Number(i.get("Content-Length")),h=Math.ceil(R/o),f=new Array(h),x=new Set;for(let r=0;r<h;r++){let y=r*o,P=r+1==h?R-1:(r+1)*o-1;const p=new z({url:t,index:r,start:y,end:P});p.emitter.on("progress",U=>{const S=f.reduce((j,B)=>j+B.progress,0)/h;s.emit("progress",S),S>=1&&s.all.delete("progress"),U>=1&&p.emitter.all.delete("progress")}),f[r]=p,x.add(p)}let d=0,g;async function m(){if(!(d===1||d===4)){g=new AbortController,d=1;try{for await(const r of T(n,Array.from(x),y=>v(y,g)))r.emitter.emit("done",r),r.emitter.all.delete("done");d=4,s.emit("done",new Blob(f.map(r=>r.blob),{type:l})),s.all.delete("done")}catch(r){(r==null?void 0:r.name)==="AbortError"?d=2:(d=3,s.emit("error",r))}}}c&&m();function E(){d=2,g.abort()}function M(){m()}return{chunks:f,emitter:s,start:m,pause:E,resume:M}}a.UnsupportedRangeError=w,a.telecharger=C,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
